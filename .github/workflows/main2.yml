name: Test Feishu Webhook

on:
  # 允许您在 GitHub Actions 界面手动触发此工作流程
  workflow_dispatch:
    inputs:
      message:
        description: '要发送的飞书消息内容 (如果机器人需要关键词，请包含)'
        required: false
        default: 'GitHub Actions Webhook 测试消息'

jobs:
  send_feishu_message:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (Optional, but good practice)
        uses: actions/checkout@v4

      - name: Send Feishu Notification (Simple Text)
        run: |
          # 检查 Secret 是否存在
          if [ -z "${{ secrets.FEISHU_WEBHOOK_URL }}" ]; then
            echo "Error: FEISHU_WEBHOOK_URL secret is not set!"
            exit 1
          fi

          # 获取用户输入的 message，如果为空则使用默认值
          MESSAGE_CONTENT="${{ github.event.inputs.message }}"
          if [ -z "$MESSAGE_CONTENT" ]; then
            MESSAGE_CONTENT="GitHub Actions Webhook 测试消息"
          fi

          # 构建 JSON Payload。
          # 优先尝试最简单的 {"text": "..."} 格式
          # 如果这个不成功，可以尝试下面注释掉的标准飞书 {"msg_type": "text", "content": {"text": "..."}} 格式
          #
          # ⚠️ 重要的提示：如果你的飞书机器人设置了关键词，确保 MESSAGE_CONTENT 包含该关键词！
          # 例如：MESSAGE_CONTENT="[TrendRadar] GitHub Actions Webhook 测试消息"

          # PAYLOAD="{\"text\": \"${MESSAGE_CONTENT}\"}"
          # 或者尝试标准飞书格式
          PAYLOAD="{\"msg_type\": \"text\", \"content\": {\"text\": \"${MESSAGE_CONTENT}\"}}"

          echo "Attempting to send payload: $PAYLOAD"
          curl -X POST \
               -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               ${{ secrets.FEISHU_WEBHOOK_URL }}

          echo "Curl command finished. Check Feishu for message."
        env:
          # 可以将 FEISHU_WEBHOOK_URL 显式设置为环境变量，虽然直接在 curl 中使用更常见
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          # 如果您的机器人需要签名，这里是放置签名的位置（但会更复杂）
          # FEISHU_SIGNATURE: ${{ secrets.FEISHU_SIGNATURE }}
